<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Mark Attendance</title>
</head>
<body>

<h2>Mark Attendance</h2>

<form id="attendanceForm">
  <input type="text" id="name" placeholder="Enter Name" required><br><br>
  <input type="text" id="roll" placeholder="Enter Roll No" required><br><br>
  <button type="submit">Submit Attendance</button>
</form>

<script>
/* ================================
   1. QR TOKEN VALIDATION
================================ */
const params = new URLSearchParams(window.location.search);
const token = params.get("token");

if (!token) {
  alert("Invalid access. Please scan QR.");
  window.location.href = "./teacher.html";
}

/* ================================
   2. DECODE QR PAYLOAD
================================ */
let payload;
try {
  payload = JSON.parse(decodeURIComponent(token));
} catch {
  alert("Invalid QR data");
  window.location.href = "./teacher.html";
}

/* ================================
   3. QR EXPIRY (10 MIN)
================================ */
if (Date.now() - payload.timestamp > 10 * 60 * 1000) {
  alert("QR expired. Ask teacher to generate again.");
  window.location.href = "./teacher.html";
}

/* ================================
   4. SESSION MATCH
================================ */
const sessionId = localStorage.getItem("sessionId");
const expiry = localStorage.getItem("expiry");

if (!sessionId || payload.session !== sessionId || Date.now() > expiry) {
  alert("Attendance session expired");
  window.location.href = "./teacher.html";
}

/* ================================
   5. LOAD LOCAL DATA
================================ */
let records = JSON.parse(localStorage.getItem("records")) || [];
let marked = JSON.parse(localStorage.getItem("marked")) || [];

/* ================================
   6. FORM SUBMIT
================================ */
document.getElementById("attendanceForm").addEventListener("submit", (e) => {
  e.preventDefault();

  const name = document.getElementById("name").value.trim();
  const roll = document.getElementById("roll").value.trim().toUpperCase();

  /* ðŸ”’ DUPLICATE BLOCK */
  if (marked.includes(roll)) {
    alert("Attendance already marked for this roll number");
    return;
  }

  const entry = {
    name: name,
    roll: roll,
    time: new Date().toLocaleString(),
    session: payload.session
  };

  /* SAVE LOCALLY */
  records.push(entry);
  marked.push(roll);
  localStorage.setItem("records", JSON.stringify(records));
  localStorage.setItem("marked", JSON.stringify(marked));

  /* SEND TO GOOGLE SHEET */
  fetch("https://script.google.com/macros/s/AKfycbyb4brPniLVtmYx-_OLr8tx5mg_CghcuGwEJnAEyCQUOX1zChGSHtB8kKm4lb1LqRh5/exec", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(entry)
  })
  .then(res => res.text())
  .then(msg => {
    console.log("Sheet response:", msg);
    alert("Attendance marked successfully");
    document.getElementById("attendanceForm").reset();
  })
  .catch(err => {
    console.error("Sheet error:", err);
    alert("Saved locally but failed to send to Google Sheet");
  });
});
</script>


</body>
</html>






