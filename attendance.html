<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Mark Attendance</title>
</head>
<body>

<h2>Mark Attendance</h2>

<form id="attendanceForm">
  <input type="text" id="name" placeholder="Enter Name" required><br><br>
  <input type="text" id="roll" placeholder="Enter Roll No" required><br><br>
  <button type="submit">Submit Attendance</button>
</form>

<script>
/* ===============================
   1. QR TOKEN VALIDATION
================================ */
const params = new URLSearchParams(window.location.search);
const token = params.get("token");

if (!token) {
  alert("Invalid access. Please scan QR.");
  window.location.href = "./teacher.html";
}

/* ===============================
   2. DECODE QR PAYLOAD
================================ */
let payload;
try {
  payload = JSON.parse(decodeURIComponent(token));
} catch (e) {
  alert("Invalid QR data");
  window.location.href = "./teacher.html";
}

/* ===============================
   3. QR TIME EXPIRY (10 MIN)
================================ */
if (Date.now() - payload.timestamp > 10 * 60 * 1000) {
  alert("QR expired. Ask teacher to generate a new one.");
  window.location.href = "./teacher.html";
}

/* ===============================
   4. SESSION MATCH CHECK
================================ */
const storedSession = localStorage.getItem("sessionId");
const expiry = localStorage.getItem("expiry");

if (!storedSession || payload.session !== storedSession || Date.now() > expiry) {
  alert("Attendance session expired");
  window.location.href = "./teacher.html";
}

/* ===============================
   5. DUPLICATE PREVENTION
================================ */
let records = JSON.parse(localStorage.getItem("records")) || [];
let marked = JSON.parse(localStorage.getItem("marked")) || [];

/* ===============================
   6. FORM SUBMISSION
================================ */
document.getElementById("attendanceForm").addEventListener("submit", (e) => {
  e.preventDefault();

  const name = document.getElementById("name").value.trim();
  const roll = document.getElementById("roll").value.trim().toUpperCase();

  if (marked.includes(roll)) {
    alert("Attendance already marked for this roll number.");
    return;
  }

  const entry = {
    name,
    roll,
    time: new Date().toLocaleTimeString()
  };

  records.push(entry);
  marked.push(roll);

  localStorage.setItem("records", JSON.stringify(records));
  localStorage.setItem("marked", JSON.stringify(marked));
  
  fetch("https://script.google.com/a/macros/aiarkp.ac.in/s/AKfycbz-eX3CNFIVbLXyW6FcEHwTaTlkNrC9hYPN0YgG2XL7mBdTjhMG1BOgw7hROKMksyCy/exec"), {
  method: "POST",
  headers: {
    "Content-Type": "application/json"
  },
  body: JSON.stringify({
    name,
    roll,


  alert("Attendance marked successfully!");
  document.getElementById("attendanceForm").reset();
});
</script>

</body>
</html>


